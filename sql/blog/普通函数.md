# 普通函数

## 算数函数

### `abs()` 绝对值

正常情况下，绝对值的结果

```sql
select abs(2);  // 2
select abs(-2); // 2
select abs(0);  // 0
select abs(-0); // 0
```

有些极端情况下，输入的值不一定是数字，我们看一下它的结果：

```sql
select abs('11');     // 11
select abs('123dd');  // 123
select abs('dd123');  // 0
select abs('mysql');  // 0
select abs(null);     // null
select abs(1/0);      // null
select abs('2022-01-22'); // 2022
select abs(true);     // 1
select abs(false);    // 0
select abs(CURRENT_TIMESTAMP()); // 20220128155334
```

总结：

- 如果是 字符串类型的数字，先将它转换成数字再做绝对值
- 如果是 数字开头加非数字字符串，取前面数字部分做绝对值
- 如果是 非数字开头，结果是 `0`
- 如果是 `null` ，结果是 `null`
- 如果是 `1/0` ，结果是 `null`
- 如果是 `true` ，结果是 `1`
- 如果是 `false` ，结果是 `0`
- 如果 字符串是通过特殊符号连接，则取第一个特殊符号前的值，做转换
- 如果是日期，则去掉日期的连接符号

### `mod()` 取余数

mod 模运算。`N % M, N MOD M` 返回 N 除以 M 的余数。

正常情况下，取余数的结果

```sql
select mod(4, 3); // 1
select mod(4, 2); // 0
select mod(3, 4); // 3
```

在极端情况下的结果

```sql
-- MOD(N,0) 返回 null
select mod(4, 0);       // null
select mod(4, 'e');     // null
select mod(4, '3');     // 1
select mod(4, '123d');  // 1
select mod(4, true);    // 0
select mod(4, 1/0);     // null
select mod(4, null);    // null
```

总结：它的转换逻辑

- 两个都是数字，直接取余
- 如果有一个或者两个不是数字，会将它们转换成数字，再进行取余
  - 如果转换后的数字是 0 或者 null 则结果 null

```sql
-- sql 中mod 的作用求余数，语法
-- mod(n, m)
-- n mod m
-- n % m
select mod(7, 4);     // 商1 余3
select mod(7, -4);    // 商-1 余3
select mod(-7, 4);    // 商-1 余-3
select mod(-7, -4);   // 商1 余-3

select 7 % 4;         // 商1 余3
select 7 % -4;        // 商-1 余3
select -7 % 4;        // 商-1 余-3
select -7 % -4;       // 商1 余-3

-- 被除数=除数*商+模
```

取模运算与取余运算的区别（sql 中 mod 符号的运算逻辑是取余）

详细参见：[[知乎]编程语言中，取余和取模的区别到底是什么？](https://www.zhihu.com/question/30526656)

取余是数学中的概念，取模是计算机中的概念，两者都是求两数相除的余数

> 注意，有些编程语言 `%` 是取模运算 python ruby

- `mod` vs `rem`(`%` remainder 取余运算)
  - 取模运算 VS 取余运算
  - 计算公式都是 定义：a = bq + r 且 0 <= |r| < |b|。
    - 对于满足a = bq + r 且 0 <= |r| < |b|条件的数据，如果a不能被b整除，有两对（q，r），其中一对中r为正数（正余数），另一对中r为负数（负余数）。
    - q更趋近无穷小（负无穷）时的r，即mod（a，b）；
    - q更趋近0时的r，即rem（a，b）；
  - 区别在于对负整数进行除法运算时操作不同。取模主要是用于计算机术语中。取余则更多是数学概念。
  - 用 `rem` 时，`dividend % divisor = remainder`
    - 余数的符号与被除数的符号相同（不管除数是正是负）
    - 取余，遵循尽可能让商向0靠近的原则
    - 被除数=除数*商+模
  - 用 `mod` 时
    - 余数的符号与除数的符号相同
    - 取模，遵循尽可能让商向负无穷靠近的原则
    - 模数，指在模算术中，是算术除法后剩余的值或剩余值。这通常称为余数。

> 解释：为什么遵循的是这样的原则？
>
> 在matlab中，关于取余和取模是这么定义的：
> 当y≠0时：
> 取余：rem(x,y)=x-y.*fix(x./y)
> 取模：mod(x,y)=x-y.*floor(x./y)
> 其中，fix()函数是向0取整，floor()函数是向负无穷取整

rem, mod 这两个函数的生成机制不同，rem 函数采用 fix 函数，而 mod 函数采用了 floor 函数
fix, floor 这两个函数都是用来取整的，fix 函数向 0 方向舍入，floor 函数向无穷小(负无穷)方向舍入

- rem(x，y) 返回的是 x-n.*y，当 y 不等于 0 时，其中的 n=fix(x./y)，
  - 与被除数具有相同的符号, 整数商向 0 方向舍入
  - -7 % 4 = -3（整数商 -1）
- mod(x, y) 返回的是 x-n.*y，当 y 不等于 0 时，其中的 n=floor(x./y)
  - 与除数具有相同的符号, 整数商向负无穷方向舍入
  - -7 mod 4 = 1（整数商 -2）

> 注意：模数始终与除数同号，余数与商同号。当至少一个为负时，将除数和余数相加得到模数。

先将两个整数看作是正数，再作除法运算:

1、能整除时，其值为 0
2、不能整除时，其值=除数×(整商+1)-被除数

> 例：mod(36,-10)=-4
> 即：36 除以 10 的整数商为 3，加 1 后为 4；其与除数之积为 40；再与被数之差为（40-36=4）；取除数的符号。所以值为 -4。
> mod(9,1.2)=0.6;
> -7 mod 4 ?
> 19 mod -12 ?

取模在灰度方案和abtest中经常用到（对随机算法要求不高）

一般来说，还是 **取模结果与被除数同符号** 比较符合大多数情况。否则商向零取整不满足等式 **被除数=除数*商+模**

- 被除数同符号，大部分编程语言都是这样：C语言，Go，C#，Java，Rust，Swift，JavaScript，PHP。
- 与除数同符号，Python，ruby。同时Python中函数 math.fmod 提供了与C语言中一致的取模运算。

### `round()` 四舍五入

正常情况下，四舍五入的结果

```sql
select round(3.24, 1); // 3.2
```

非正常情况下的结果

```sql
select round(3.23, null); // null
select round(3.23, 1/0);  // null
```

总结：算术类的函数，如果输入的值不是数字，会先将它转换成数字，然后在进行后面的操作。

## 字符串函数

### `concat()` 连接函数

正常情况下使用 concat() 的结果

```sql
select concat('abc', 123); // 'abc123'
```

在极端情况下使用结果

```sql
select concat('abc', true);   // 'abc1'
select concat('abc', false);  // 'abc0'
select concat('abc', null);   // null
select concat('abc', 1/0);    // null
select concat('abc', CURRENT_TIMESTAMP()); // abc2022-01-29 14:52:01
```

这个函数比较简单，没有太多极端的情况，和 `null` 连接，结果就是 `null`

### `length()` 计算长度

一个汉字算三个字符，一个数字或者字母算一个字符

```sql
select length('abc');  // 3
select length(23);  // 2
select legnth(1.2); // 3
select length("你好"); // 6
```

极端情况的结果

```sql
select length(true); // 1，true 是 1 所以结果是 1
select length(null); // null
```

### `char_length()` 字符长度

字母，数字，汉字都算一个字符

```sql
select char_length('abc');  // 3
select char_length('你好');  // 2
select char_length(123);    // 3
select char_length(true);   // 1
select char_legnth(null);   // null
```

### `lower()`、`upper()` 大小写函数

```sql
select lower('FF');   // 'ff'
select lower(1);      // 1
select lower(true);   // 1
select lower(null);   // null
select lower(1/0);    // null
select lower('你好');   // '你好'
```

`upper()` 和 `lower()` 用法一样，如果是不是字母，输出原值

### `replace()` 替换函数

```sql
select replace('abc', 'c', 'd');    // 'abd'
select replace('abc', 'd', 'D');    // 'abc'
select replace('abc', 'c', true);   // 'ab1'
select replace('abc', 'c', null);   // null
select replace(true, 1, 'abc');     // 'abc'
select replace(true, true, 'abc');  // 'abc'
select replace(true, 'a', 34);      // 1
```


### `substring(string, start, length)` 截取字符串函数

`start` 表示开始截取的位置，`length` 数字表示截取的长度，

- `start` 从 `1` 开始，不是 `0`
- `start` 如果是负数，表示从后往前开始

```sql
select substring('abcd', 1, 3);   // 'abc'
select substring('abcd', 0, 3);   //  空
select substring('abcd', 3, 1);   // 'c'
select substring('abcd', 3, -1);  //  空
select substring('abcd', 1, 1);   // 'a'
select substring('abcd', 2, 2);   // 'bc'
select substring('abcd', -1, 1);  // 'd'
select substring('abcd', 1, null);  // null
select substring('abcd', 1, 'd');   //  空
```

## 日期函数

- `current_time()` 获取当前系统的时间
- `current_date()` 获取当前系统的日期
- `current_timestamp()` 获取当前系统的时间 + 日期
- `extract()` 获取具体的年月日
- `date()` 获取时间的日期部分
- `year()` 获取时间的年份部分
- `month()` 获取时间的月份部分
- `day()` 获取时间的天数部分
- `hour()` 获取时间的小时部分
- `minute()` 获取时间的分钟部分
- `second()` 获取时间的秒部分

```sql
select current_time();      // 12:01:34
select current_date();      // 2022-01-30
select current_timestamp(); // 2022-01-30 12:01:34
select extract(year from '2022-01-30 12:01:34'); // 2022
select date('2022-01-30 12:01:34');   // 2021-01-30
select year('2022-01-30 12:01:34');   // 2022
select month('2022-01-30 12:01:34');  // 01
select day('2022-01-30 12:01:34');    // 30
select hour('2022-01-30 12:01:34');   // 12
select minute('2022-01-30 12:01:34'); // 01
select second('2022-01-30 12:01:34'); // 34
```

## 转换函数

### `cast()` 数据类型转换

参数是个表达式，通过 `as` 分割 2 个参数，一个是原始数据，一个是目标类型

```sql
select cast(12.3 as signed);  // 12
select cast(12.3 as char);    // 12.1
```

将字符串数字转成 int 类型会报错，转成 float 类型就不会报错

```sql
select cast('12' as int);   // 报错
select cast('12' as float); // 12
```

还可以使用 `decimal()` 指定精度，接收两个参数，第一个参数是精度位（包括小数部分），第二个参数是小数位数

下面的 SQL 语句中，为什么两个输出值是一样的？

因为小数位是两个，小数位加整数位不够八位，所以，最后呈现出来的是 6 。

```sql
select cast('1234.56789' as decimal(8, 2)); // 1234.57
select cast('1234.56789' as decimal(6, 2)); // 1234.57
```

### `coalesce()` 返回第一个非空数值

```sql
select coalesce(null, null, 2);  // 2
select coalesce(null, 1); // 1
```
