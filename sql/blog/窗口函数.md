# 各种窗口函数的使用

- [普通函数](https://github.com/astak16/blog-mysql/issues/39)
  - 算数函数
  - 字符串函数
  - 日期函数
  - 转换函数
- [窗口函数](https://github.com/astak16/blog-mysql/issues/40)
  - 排名函数
  - 分布函数
  - 偏移量函数
  - 其他函数
- https://github.com/astak16/blog-mysql/issues/38
- https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html

窗口函数的作用是用来简化排名问题，否则将会写一大堆晦涩难懂的代码。

窗口函数与聚合函数的区别是：

- 窗口函数会为每一行返回一个相应的值
  - https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html
- 聚合函数是将一组行计算后返回一个值。
  - https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html

1. 排名函数：
   1. rank()
   2. row_number()
   3. dense_rank()
2. 分布函数：
   1. percent_rank()
   2. cume_dist()
3. 偏移量函数：
   1. lead()
   2. lag()
4. 其他函数：
   1. first_value()
   2. last_value()
   3. nth_value()
   4. ntile()

## 序号函数/排名函数


## 偏移量函数

### lead()

### lag()

## 分布函数

### percent_rank()

### cume_dist()


## 其他函数

### first_value()

### last_value()

### nth_value()


### ntile()

使用ntile()函数，将表中数据分为多份

ntile函数可以对序号进行分组处理，将有序分区中的行分发到指定数目的组中。


```sql
SELECT A.*
FROM (
   SELECT
      T.*,
      NTILE(9) OVER (
         ORDER BY T.ROWID ASC
      ) NTI
   FROM T_XXXX T
   ) A
WHERE A.NTI = 3\n
```


四分位数(Quartile),即统计学中,把所有数值由小到大排列并分成四等份,处于三个分割点位置的得分就是四分位数

- 第一四分位数 (Q1),又称'较小四分位数',等于该样本中所有数值由小到大排列后第25%的数字
- 第二四分位数 (Q2),又称'中位数',等于该样本中所有数值由小到大排列后第50%的数字
- 第三四分位数 (Q3),又称'较大四分位数',等于该样本中所有数值由小到大排列后第75%的数字
- 第三四分位数与第一四分位数的差距又称四分位距(InterQuartile Range,IQR)

1:将数据从小到大排序,计为数组a(1 to n),n代表数据的长度
2:确定四分位数的位置b,b的整数部分计为c,b的小数部分计为d

  Q1的位置 b = (n+1) * 0.25
  Q2的位置 b = (n+1) * 0.5
  Q3的位置 b = (n+1) * 0.75

另外一种方法基于n-1 基础.即

  Q1的位置 b = (n-1) * 0.25
  Q2的位置 b = (n-1) * 0.5
  Q3的位置 b = (n-1) * 0.75

Excel中有两个四分位数的函数QUARTILE.EXC 和QUARTILE.INC
QUATILE.EXC 基于n+1 的方法,QUARTILE.INC基于n-1的方法

3:计算

  Q1=a(c)+[a(c+1)-a(c)]*d,Q2与Q3的求法类似
*/

```sql
--SQL实现
SELECT
   shopcode,
   quarter,
   a+(b-a)*c AS QUARTILE
FROM
(
    SELECT
    shopcode,
    quartername,
    MAX(CASE WHEN id = FLOOR(r) THEN pforce ELSE NULL END) AS a,
    MAX(CASE WHEN id = FLOOR(r)+1 THEN pforce ELSE NULL END) AS b,
    MAX(r-FLOOR(r)) AS c
    FROM
    (
       SELECT *,
       ROW_NUMBER() OVER(PARTITION BY shopcode,quartername ORDER BY pforce) AS id,
       (1+COUNT(1) OVER(PARTITION BY shopcode,quartername)) * 0.75 AS r
       FROM ttt
    ) A
    GROUP BY shopcode,quartername
) B
```

- [分位数和各种Sql 四大排名函数](https://zhuanlan.zhihu.com/p/374249753)
- [四分位数SQL实现](https://blog.csdn.net/mxbing1984/article/details/113928186)
- [【PostgreSQL】函数之百分位数&中位数：percentile_cont()](https://blog.csdn.net/qq_34105362/article/details/80650868)
