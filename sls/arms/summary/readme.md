# 汇总指标

将需要整体使用的数据汇总看效果(转存到一个 logstore)

1. 日志用量分布及分析（监控资源包消耗）
2. 核心指标汇总
   1. JS 错误率（错误 PV/总 PV）
   2. FMP 首屏时间指标 （各时间区段汇总）
3. JS 错误类型汇总
   1. 用于整体分析错误情况


## 问题

1. 是否可以用作告警？

可以整体做粗略告警，无页面聚合分类

- 每天汇总 report 报告
- pv, uv 用于趋势观察
- 75% 90% 性能指标点位？ 用于性能分析
- 按应用
  - pv, uv 趋势观察
  - 错误类型汇总（有些错误，一个都不允许出现）
  - 75% 90% 性能指标点位

## 创建和评估警报策略

当关键绩效指标飙升或下降时，需要通知组织中的个人和团队。使您能够在问题影响最终用户之前检测到问题。

可以通过两种主要方式设置警报策略：

- 当您已经知道应用程序的性质及其正常行为不太可能很快改变时，**静态阈值警报非常有用**。Apdex 分数、响应时间、错误率、吞吐量是您可以创建警报策略的一些静态阈值。
- 动态异常警报使为具有不同季节性模式和增长趋势的应用程序确定和设置动态警报阈值变得容易（这使得设置定义正常行为的阈值变得困难）。这些警报使用从应用程序的历史指标数据建模的异常。

识别和设置关键交易

密切监控您认为是应用程序最关键业务的事务，无论是响应时间、调用计数、错误率还是其他。

建议的一些推荐警报是**错误百分比**、**apdex** 或**响应时间**。


> 状况建议仅适用于具有灰色（或未知）健康状态的 APM 监控实体。

可能会根据机器学习模型获得推荐的警报条件

如果您没有获得推荐的警报条件，一旦您选择了您想要监控的警报条件，那么当此信号偏离其正常基线（上限和下限）至少 5 分钟（按 3.00 标准）时，您的团队将收到警报偏差。


警报条件只需要两个属性：查询和阈值。

报警策略:


### sentry 报警

术语

- Event: 应用端每次触发异常，就是一次 Event，会上报到 Sentry 中
- Issue: Sentry 把同一位置触发的异常聚合在一起就是 Issue，在 Sentry 中以 Issue 为主要单位分析问题

> 多想一步：Sentry 如何把 Event 聚合成 Issue，即如何确认多个 Event 都是在同一位置触发的？

报警规则（Alert Rule）

以下是常见却容易被忽略的报警规则

1. 当只有生产环境下的 Issue 才会触发报警
2. 当只有异常级别大于 Error 才会触发报警
3. 新的 Issue 增加
4. 错误频率增加
5. 已解决和忽略的问题变得未解决

监控指标

1. 项目中的总错误
2. 延迟：最小值、最大值、平均值、百分位数
3. 失败率
4. 用于监控发布运行状况的无崩溃会话或用户率
5. 自定义指标

- 错误(Errors)
  - 错误数
  - 错误影响用户数
- 会话（崩溃率警报） Sessions(Crash Rate Alerts)
  - 无崩溃回话率
  - 无崩溃用户率
- 性能表现(Performance)
  - 吞吐量
  - 交易时间
  - 顶点索引
  - 失败率
  - 最大的内容显示
  - 首次输入延迟
  - 累积版面偏移
  - 自定义指标

- An event is seen：当一个事件发生时
  - An issue is first seen：错误第一次出现
  - An issue changes state from resolved to unresolved：针对已修复问题复现场景
  - An issue changes state from ignored to unresolved：当xx条件下“忽略”的问题重新触发时进行提醒
  - An issue is seen more than xx times in xx time：对于一些已知的低级别，不影响使用的问题可以设置超过多少次以后再进行告警
  - An event's tags match xx equal to/does not equal xxx：根据事件标签值进行相应决策
  - An event's level is equal/does not equal xxx：选择事件级别（致命的/错误/警告/日志）

入站过滤器

通过入站过滤器可以针对某些版本、某些IP地址用户或者针对指定版本浏览器原因造成的问题进行过滤处理。最重要的是我们可以通过入站过滤器进行自定义过滤规则对一些已知可忽视问题进行设置，比如针对一些请求超时、没有权限，登录态失效等非代码健壮性问题。

Issue Owners

通过Issue Owners选项我们可以在Issue发生时自动建立Issue与责任人关联关系，与此同时直接发送(xxx)通知给对应负责的小伙伴。一共有两种设置方式，都是根据正则表达式进行匹配。

- 路径(path)：通过指定源文件所在目录及owners
- 页面路由(url)：通过指定具体页面路由及owners

错误解决方案

- Resolve
  - 当前版本解决：发完版本以后，修改issue状态
  - 下个版本解决：issue发现后马上解决，代码跟随下个版本上线
  - 其他版本：一般不使用该选项
- Ignore
  - 时间维度：xx时间之前忽略（可自定义时间）
  - 数量维度：再出现xx次之前忽略
  - 用户维度：再有xx个用户复现这个错误之前忽略


### 分析

第一次/最后一次报错

- First Seen: 第一次报错时间有助于捕捉到该异常发生的版本号
- Last Seen: 最后一次报错时间决定这个异常是否已解决，或者是否还需要解决

获取到 Release

Release 就是版本号，这个需要在代码中手动配置。

1. 快速推断出出现问题的 Commit，并指定给对应的提交者
2. 对该 Release 出现的问题进行聚类
